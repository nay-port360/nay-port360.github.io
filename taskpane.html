<!DOCTYPE html>
<html>
<head>
	<!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
	<button id="createEnquiry">create Enquiry 1</button>
</body>

<script>
	Office.onReady((info) => {
        if (info.host === Office.HostType.Outlook) {
            document.getElementById("createEnquiry").onclick = createEnquiry;
        }
    });

    function createEnquiry() {
		const item = Office.context.mailbox.item;

		item.getCallbackTokenAsync({ isRest: true }, function (result) {
			if (result.status === Office.AsyncResultStatus.Succeeded) {
				const token = result.value;
				const itemId = item.itemId;

				fetch(`https://outlook.office.com/api/v2.0/me/messages/${itemId}`, {
					headers: {
						'Authorization': `Bearer ${token}`,
						'Accept': 'application/json; odata.metadata=none'
					}
				})
				.then(response => response.json())
				.then(email => {
					const emailBlob = new Blob([JSON.stringify(email)], { type: 'message/rfc822' });
					uploadFileToEndpoint(emailBlob, 'email.eml');
				})
				.catch(error => {
					console.error('Error fetching email content:', error);
				});
			} else {
				console.error("Error getting callback token:", result.error.message);
			}
		});
	}

	function uploadFileToEndpoint(file, filename) {
		const endpointUrl = 'https://p360.test/api/upload-tmp-file';
		const token = '4|SMV55jMAKXni9oVKrV1w03g4sCT3anr7pW7OBe24';

		const formData = new FormData();
		formData.append('file', file, filename);

		fetch(endpointUrl, {
			method: 'POST',
			headers: {
				'Authorization': `Bearer ${token}`
			},
			body: formData
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
		})
		.catch((error) => {
			console.error('Error:', error);
		});
	}
</script>
</html>